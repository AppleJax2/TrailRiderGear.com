---
import { buildAmazonLink } from '../../lib/affiliate';

export interface Product {
  id: string;
  name: string;
  brand: string;
  price: string;
  rating?: number;
  asin?: string;
  amazonUrl?: string;
  badge?: string;
}

export interface Props {
  products: Product[];
  title?: string;
  category?: string;
}

const { products, title = "Featured Gear", category } = Astro.props;

const affiliateTag = 'trailridergea-20';

const getAmazonUrl = (product: Product) => {
  return product.amazonUrl || (product.asin ? `https://www.amazon.com/dp/${product.asin}?tag=${affiliateTag}&linkCode=ll1` : '#');
};
---

<div class="featured-products-widget">
  <div class="widget-header">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
      <line x1="3" y1="6" x2="21" y2="6"/>
      <path d="M16 10a4 4 0 0 1-8 0"/>
    </svg>
    <h4>{title}</h4>
  </div>
  
  <div class="products-list">
    {products.slice(0, 5).map((product, index) => (
      <a href={getAmazonUrl(product)} target="_blank" rel="nofollow sponsored" class="product-item">
        <div class="rank">{index + 1}</div>
        <div class="product-details">
          <div class="brand">{product.brand}</div>
          <div class="name">{product.name}</div>
          {product.rating && (
            <div class="mini-rating">
              <span class="stars">{'â˜…'.repeat(Math.round(product.rating))}</span>
              <span class="rating-num">{product.rating}</span>
            </div>
          )}
        </div>
        <div class="price-action">
          <span class="price">{product.price}</span>
          <span class="arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </span>
        </div>
      </a>
    ))}
  </div>
  
  <div class="affiliate-note">
    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="16" x2="12" y2="12"/>
      <line x1="12" y1="8" x2="12.01" y2="8"/>
    </svg>
    Affiliate links - we may earn a commission
  </div>
</div>

<style>
  .featured-products-widget {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1rem;
  }
  
  .widget-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }
  
  .widget-header svg {
    color: var(--color-primary);
  }
  
  .widget-header h4 {
    font-size: 0.875rem;
    font-weight: 700;
    margin: 0;
    color: var(--color-text);
  }
  
  .products-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .product-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }
  
  .product-item:hover {
    background: var(--color-background);
    border-color: var(--color-border);
  }
  
  .rank {
    width: 24px;
    height: 24px;
    background: var(--color-border);
    color: var(--color-text);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6875rem;
    font-weight: 700;
    flex-shrink: 0;
  }
  
  .product-item:hover .rank {
    background: var(--color-primary);
    color: var(--color-background);
  }
  
  .product-details {
    flex: 1;
    min-width: 0;
  }
  
  .brand {
    font-size: 0.625rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-primary);
    font-weight: 600;
  }
  
  .name {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text);
    line-height: 1.3;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .mini-rating {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.6875rem;
  }
  
  .mini-rating .stars {
    color: #f59e0b;
    letter-spacing: -1px;
  }
  
  .mini-rating .rating-num {
    color: var(--color-text-muted);
  }
  
  .price-action {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  .price {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--color-primary);
  }
  
  .arrow {
    color: var(--color-text-muted);
    transition: color 0.2s ease;
  }
  
  .product-item:hover .arrow {
    color: var(--color-primary);
  }
  
  .affiliate-note {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--color-border);
    font-size: 0.625rem;
    color: var(--color-text-muted);
  }
</style>
